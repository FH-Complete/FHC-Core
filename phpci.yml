build_settings:
    verbose: false
    prefer_symlink: false
    ignore:
        - "vendor"
        - "tests"
    pgsql:
        host: 'localhost;dbname=template1'
        user: 'fhcomplete'
        pass: 'fhcomplete'

setup:
    composer:
        action: "install"
        prefer_dist: true
        no_dev: true
    pgsql:
        - "UPDATE pg_database SET datallowconn = 'false' WHERE datname = 'fhctest';"
        - "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE pid <> pg_backend_pid() AND datname = 'fhctest';"
        - "DROP DATABASE IF EXISTS fhctest;"
        - "CREATE DATABASE fhctest OWNER fhcomplete;"
    shell:
        #- "cd %BUILD_PATH% && chmod u+x install.sh && ./install.sh fhctest" # Install Database
        - "cd %BUILD_PATH% && php index.ci.php DBTools migrate" # Install Database
        - "rm -f /var/www/phpci/PHPCI/build/fhcomplete.ci" # SymLink l√∂schen falls vorhanden
        - "ln -s %BUILD_PATH% /var/www/phpci/PHPCI/build/fhcomplete.ci" # SymLink to the actual build

test:
    lint:
        directories:
            - "application/"
        recursive: true
    codeception:
        config: "tests/codeception/"
        path: "tests/codeception/_output/"
#    php_docblock_checker:
#        path: "application/controllers/"
#        allowed_warnings: 100
#        skip_classes: false
#    php_code_sniffer:
#        path: "application/controllers/"
#        standard: "tests/codesniffer/FHComplete"
#        allowed_errors: 200
#        allowed_warnings: 200
#    php_unit:
#        directory: "tests/phpunit/"

complete:
    pgsql:
        - "UPDATE pg_database SET datallowconn = 'false' WHERE datname = 'fhctest';"
        - "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE pid <> pg_backend_pid() AND datname = 'fhctest';"
        - "DROP DATABASE IF EXISTS fhctest;"